<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <title>Family Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Family Tracker - real-time location monitoring and perimeter alerts">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%230ea5e9' stroke-width='2'%3E%3Cpath d='M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z'/%3E%3Ccircle cx='12' cy='10' r='3'/%3E%3C/svg%3E">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css">
  <link rel="stylesheet" href="style.css?v=20251205b">
</head>
<body>
  <div class="container">
    <!-- Topbar s centrovými date controls -->
    <div id="topbar" role="toolbar" aria-label="Ovládanie dátumu">
      <!-- Ľavá strana: logo a názov s prepínačom subdomén -->
      <div class="topbar-left">
        <div class="subdomain-switcher">
          <button class="subdomain-toggle" id="subdomainToggle" aria-label="Prepnúť aplikáciu">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/>
              <circle cx="12" cy="10" r="3"/>
            </svg>
            <span class="subdomain-name">Family Tracker</span>
            <svg class="subdomain-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"/>
            </svg>
          </button>

          <div id="subdomainMenu" class="subdomain-menu hidden">
            <a href="https://bagron.eu" class="subdomain-item">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                <polyline points="9 22 9 12 15 12 15 22"/>
              </svg>
              <div class="subdomain-info">
                <span class="subdomain-title">Family Office</span>
                <span class="subdomain-url">bagron.eu</span>
              </div>
            </a>
            <a href="https://portfolio.bagron.eu" class="subdomain-item">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <line x1="18" y1="20" x2="18" y2="10"/>
                <line x1="12" y1="20" x2="12" y2="4"/>
                <line x1="6" y1="20" x2="6" y2="14"/>
              </svg>
              <div class="subdomain-info">
                <span class="subdomain-title">Portfolio Tracker</span>
                <span class="subdomain-url">portfolio.bagron.eu</span>
              </div>
            </a>
          </div>
        </div>
      </div>
      
      <!-- Stred: Date controls -->
      <div class="topbar-center">
        <button id="prevDay" aria-label="Predchádzajúci deň">◀</button>
        <button id="calendarToggle" aria-label="Otvoriť kalendár">
          <span id="currentDate" aria-live="polite"></span>
          <span class="dropdown-icon">▼</span>
        </button>
        <button id="nextDay" aria-label="Nasledujúci deň">▶</button>
        <button id="today" aria-label="Dnešný deň">Dnes</button>
        
        <!-- Kalendár dropdown -->
        <div id="calendarDropdown" class="calendar-dropdown hidden">
          <div class="calendar-header">
            <button id="calPrevMonth" aria-label="Predchádzajúci mesiac">‹</button>
            <span id="calMonthYear"></span>
            <button id="calNextMonth" aria-label="Nasledujúci mesiac">›</button>
          </div>
          <div class="calendar-grid" id="calendarGrid"></div>
        </div>
      </div>
      
      <!-- Pravá strana: Last Online + Battery + Hamburger -->
      <div class="topbar-right">
        <!-- Last online info -->
        <div id="lastOnlineInfo" class="last-online-info" title="Posledný update">
          <svg class="clock-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
          <span id="lastOnlineText">-</span>
        </div>
        
        <!-- Battery indicator -->
        <div id="batteryIndicator" class="battery-indicator" title="Stav batérie">
          <!-- Good battery icon (full) -->
          <svg class="battery-icon-good" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="2" y="7" width="18" height="10" rx="1"></rect>
            <path d="M22 11v2"></path>
            <rect x="4" y="9" width="14" height="6" rx="0.5" fill="currentColor" stroke="none"></rect>
          </svg>
          <!-- Low battery icon (empty with warning) -->
          <svg class="battery-icon-low" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="2" y="7" width="18" height="10" rx="1"></rect>
            <path d="M22 11v2"></path>
            <rect x="4" y="9" width="4" height="6" rx="0.5" fill="currentColor" stroke="none"></rect>
            <path d="M12 9v4M12 15v.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
          </svg>
          <span id="batteryText" class="battery-text">-</span>
        </div>
        
        <!-- Hamburger menu button + dropdown container -->
        <div class="hamburger-container">
          <button id="hamburgerBtn" class="hamburger-btn" aria-label="Otvoriť menu">
            <span></span>
            <span></span>
            <span></span>
          </button>
          
          <!-- Hamburger menu dropdown -->
          <div id="hamburgerMenu" class="hamburger-menu hidden">
      <button class="menu-item" id="menuRefetch">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
          <path d="M3 3v5h5"/>
          <path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/>
          <path d="M16 21h5v-5"/>
        </svg>
        Refetch deň
      </button>
      <div class="menu-submenu">
        <button class="menu-item menu-parent" id="menuIBeacons">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3"/>
            <path d="M8 12a4 4 0 0 1 8 0"/>
            <path d="M5 12a7 7 0 0 1 14 0"/>
            <path d="M2 12a10 10 0 0 1 20 0"/>
          </svg>
          Správa iBeaconov
          <svg class="submenu-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="6 9 12 15 18 9"/>
          </svg>
        </button>
        <div class="submenu-items hidden">
          <button class="menu-item submenu-item" id="menuManageIBeacons">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19"/>
              <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            Pridať iBeacon
          </button>
          <button class="menu-item submenu-item" id="menuViewIBeacons">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="8" y1="6" x2="21" y2="6"/>
              <line x1="8" y1="12" x2="21" y2="12"/>
              <line x1="8" y1="18" x2="21" y2="18"/>
              <line x1="3" y1="6" x2="3.01" y2="6"/>
              <line x1="3" y1="12" x2="3.01" y2="12"/>
              <line x1="3" y1="18" x2="3.01" y2="18"/>
            </svg>
            Zoznam iBeaconov
          </button>
        </div>
      </div>
      <button class="menu-item" id="menuPerimeters">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polygon points="12 2 22 8.5 22 15.5 12 22 2 15.5 2 8.5"/>
          <line x1="12" y1="22" x2="12" y2="15.5"/>
          <polyline points="22 8.5 12 15.5 2 8.5"/>
        </svg>
        Perimeter zóny
      </button>
      <button class="menu-item" id="menuSettings">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="3"/>
          <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
        </svg>
        Nastavenia
      </button>
    </div>
        </div> <!-- End hamburger-container -->
      </div> <!-- End topbar-right -->
    </div> <!-- End topbar -->

    <div class="map-wrap">
      <div id="map" role="region" aria-label="Mapa s trasou a polohami"></div>
    </div>

    <!-- Tabuľka časových úsekov -->
    <div id="positionsTable" aria-live="polite">-</div>

    <footer class="site-footer">
      <p>&copy; 2025 Family Tracker</p>
    </footer>
  </div>

  <!-- iBeacon Management Overlay -->
  <div id="ibeaconOverlay" class="overlay hidden">
    <div class="overlay-content">
      <div class="overlay-header">
        <h2 id="overlayTitle">Pridať iBeacon</h2>
        <button id="overlayClose" class="overlay-close" aria-label="Zavrieť">&times;</button>
      </div>
      
      <div class="overlay-body">
        <!-- Form -->
        <form id="ibeaconForm" novalidate>
          <input type="hidden" id="beaconId" value="">
          
          <label for="beaconName">Názov
            <input type="text" id="beaconName" placeholder="Názov iBeaconu" autocomplete="off" required>
          </label>
          
          <label for="beaconMac">MAC adresa
            <input type="text" id="beaconMac" placeholder="AA:BB:CC:DD:EE:FF"
              inputmode="latin" autocomplete="off"
              pattern="^[0-9A-Fa-f]{2}(:?[0-9A-Fa-f]{2}){5}$"
              title="AA:BB:CC:DD:EE:FF" required>
          </label>
          
          <label for="beaconLat">Šírka (Latitude)
            <input type="number" id="beaconLat" placeholder="48.1486" step="0.000001" required>
          </label>
          
          <label for="beaconLng">Dĺžka (Longitude)
            <input type="number" id="beaconLng" placeholder="17.1077" step="0.000001" required>
          </label>
          
          <div class="form-actions">
            <button type="button" id="selectOnMap" class="btn-secondary">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                <circle cx="12" cy="10" r="3"/>
              </svg>
              Vyber na mape
            </button>
            <button type="button" id="submit" class="btn-primary">Uložiť</button>
            <button type="button" id="cancelEdit" class="btn-secondary">Zrušiť</button>
          </div>
        </form>
        
        <!-- Map selector (hidden by default) -->
        <div id="mapSelector" class="map-selector hidden">
          <p class="map-help">Klikni na mape pre výber polohy iBeaconu</p>
          <div id="selectorMap"></div>
          <div class="map-actions">
            <button type="button" id="confirmLocation" class="btn-primary">Potvrdiť polohu</button>
            <button type="button" id="cancelMapSelect" class="btn-secondary">Zrušiť</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- iBeacon List Overlay -->
  <div id="ibeaconListOverlay" class="overlay hidden">
    <div class="overlay-content">
      <div class="overlay-header">
        <h2>Zoznam iBeaconov</h2>
        <button id="listOverlayClose" class="overlay-close" aria-label="Zavrieť">&times;</button>
      </div>

      <div class="overlay-body">
        <div id="ibeaconList" aria-live="polite">Načítavam...</div>
      </div>
    </div>
  </div>

  <!-- Settings Overlay -->
  <div id="settingsOverlay" class="overlay hidden">
    <div class="overlay-content settings-content">
      <div class="overlay-header">
        <h2>Nastavenia</h2>
        <button id="settingsOverlayClose" class="overlay-close" aria-label="Zavrieť">&times;</button>
      </div>

      <div class="overlay-body">
        <form id="settingsForm" novalidate>

          <!-- Režim zobrazenia -->
          <div class="setting-group">
            <div class="setting-header">
              <label>
                <strong>Režim zobrazenia</strong>
              </label>
            </div>
            <div class="setting-description">
              Vzhľad aplikácie - automaticky podľa nastavenia zariadenia, svetlý alebo tmavý režim.
            </div>
            <div class="theme-toggle-group">
              <label class="theme-option">
                <input type="radio" name="theme" value="auto" checked>
                <span class="theme-label">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="5"/>
                    <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
                  </svg>
                  Auto
                </span>
              </label>
              <label class="theme-option">
                <input type="radio" name="theme" value="light">
                <span class="theme-label">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="5"/>
                    <line x1="12" y1="1" x2="12" y2="3"/>
                    <line x1="12" y1="21" x2="12" y2="23"/>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                    <line x1="1" y1="12" x2="3" y2="12"/>
                    <line x1="21" y1="12" x2="23" y2="12"/>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                  </svg>
                  Svetlý
                </span>
              </label>
              <label class="theme-option">
                <input type="radio" name="theme" value="dark">
                <span class="theme-label">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                  </svg>
                  Tmavý
                </span>
              </label>
            </div>
          </div>

          <!-- Hysteréza vzdialenosti -->
          <div class="setting-group">
            <div class="setting-header">
              <label for="hysteresisMeters">
                <strong>Minimálna vzdialenosť zmeny polohy</strong>
                <span class="setting-current" id="currentHysteresisMeters">—</span>
              </label>
              <button type="button" class="btn-default" data-setting="hysteresis_meters" data-default="50">
                Predvolené
              </button>
            </div>
            <div class="setting-description">
              Minimálna vzdialenosť v metroch, ktorú musí zariadenie prejsť, aby sa zaznamenala nová poloha. Vyššia hodnota = menej záznamov, ale menšia presnosť.
            </div>
            <div class="setting-input-group">
              <input type="number" id="hysteresisMeters" name="hysteresis_meters"
                     min="10" max="500" step="5" placeholder="50">
              <span class="setting-unit">m</span>
              <span class="setting-range">(10 – 500 m)</span>
            </div>
          </div>

          <!-- Hysteréza času -->
          <div class="setting-group">
            <div class="setting-header">
              <label for="hysteresisMinutes">
                <strong>Minimálny čas zmeny polohy</strong>
                <span class="setting-current" id="currentHysteresisMinutes">—</span>
              </label>
              <button type="button" class="btn-default" data-setting="hysteresis_minutes" data-default="30">
                Predvolené
              </button>
            </div>
            <div class="setting-description">
              Minimálny časový interval v minútach medzi záznamami polohy. Aj keď sa vzdialenosť zmení, nová poloha sa zaznamená až po uplynutí tohto času.
            </div>
            <div class="setting-input-group">
              <input type="number" id="hysteresisMinutes" name="hysteresis_minutes"
                     min="5" max="180" step="5" placeholder="30">
              <span class="setting-unit">min</span>
              <span class="setting-range">(5 – 180 min)</span>
            </div>
          </div>

          <!-- Presnosť súradníc -->
          <div class="setting-group">
            <div class="setting-header">
              <label for="uniquePrecision">
                <strong>Presnosť súradníc</strong>
                <span class="setting-current" id="currentUniquePrecision">—</span>
              </label>
              <button type="button" class="btn-default" data-setting="unique_precision" data-default="6">
                Predvolené
              </button>
            </div>
            <div class="setting-description">
              Počet desatinných miest pre GPS súradnice. Viac = vyššia presnosť (6 = ~11 cm, 5 = ~1 m, 4 = ~11 m).
            </div>
            <div class="setting-input-group">
              <input type="number" id="uniquePrecision" name="unique_precision"
                     min="4" max="8" step="1" placeholder="6">
              <span class="setting-unit">desatinných miest</span>
              <span class="setting-range">(4 – 8)</span>
            </div>
          </div>

          <!-- Časový bucket -->
          <div class="setting-group">
            <div class="setting-header">
              <label for="uniqueBucketMinutes">
                <strong>Časový interval pre unikátne polohy</strong>
                <span class="setting-current" id="currentUniqueBucketMinutes">—</span>
              </label>
              <button type="button" class="btn-default" data-setting="unique_bucket_minutes" data-default="30">
                Predvolené
              </button>
            </div>
            <div class="setting-description">
              Časový interval v minútach, v ktorom sa duplicitné polohy zlúčia do jednej. Vyššia hodnota = menej záznamov.
            </div>
            <div class="setting-input-group">
              <input type="number" id="uniqueBucketMinutes" name="unique_bucket_minutes"
                     min="5" max="180" step="5" placeholder="30">
              <span class="setting-unit">min</span>
              <span class="setting-range">(5 – 180 min)</span>
            </div>
          </div>

          <!-- Cache pre MAC adresy -->
          <div class="setting-group">
            <div class="setting-header">
              <label for="macCacheMaxAgeDays">
                <strong>Platnosť cache pre Wi-Fi geolokáciu</strong>
                <span class="setting-current" id="currentMacCacheMaxAgeDays">—</span>
              </label>
              <button type="button" class="btn-default" data-setting="mac_cache_max_age_days" data-default="3600">
                Predvolené
              </button>
            </div>
            <div class="setting-description">
              Počet dní, po ktoré sa uchovávajú GPS súradnice Wi-Fi prístupových bodov v cache. Vyššia hodnota šetrí API requesty.
            </div>
            <div class="setting-input-group">
              <input type="number" id="macCacheMaxAgeDays" name="mac_cache_max_age_days"
                     min="1" max="7200" step="30" placeholder="3600">
              <span class="setting-unit">dní</span>
              <span class="setting-range">(1 – 7200 dní)</span>
            </div>
          </div>

          <!-- Google Force -->
          <div class="setting-group">
            <div class="setting-header">
              <label for="googleForce">
                <strong>Vynútiť Google Geolocation API</strong>
                <span class="setting-current" id="currentGoogleForce">—</span>
              </label>
              <button type="button" class="btn-default" data-setting="google_force" data-default="0">
                Predvolené
              </button>
            </div>
            <div class="setting-description">
              Ak je zapnuté, všetky Wi-Fi lokalizácie budú používať Google Geolocation API namiesto cache. Vypnuté šetrí API requesty a náklady.
            </div>
            <div class="setting-input-group">
              <div class="toggle-switch">
                <input type="checkbox" id="googleForce" name="google_force">
                <label for="googleForce" class="toggle-label">
                  <span class="toggle-inner"></span>
                  <span class="toggle-switch-text"></span>
                </label>
              </div>
            </div>
          </div>

          <!-- Akčné tlačidlá -->
          <div class="form-actions">
            <button type="button" id="saveSettings" class="btn-primary">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                <polyline points="17 21 17 13 7 13 7 21"/>
                <polyline points="7 3 7 8 15 8"/>
              </svg>
              Uložiť nastavenia
            </button>
            <button type="button" id="cancelSettings" class="btn-secondary">Zrušiť</button>
            <button type="button" id="resetAllSettings" class="btn-reset">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                <path d="M3 3v5h5"/>
                <path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/>
                <path d="M16 21h5v-5"/>
              </svg>
              Obnoviť všetko na predvolené
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Perimeter Management Overlay -->
  <div id="perimeterOverlay" class="overlay hidden">
    <div class="overlay-content perimeter-content perimeter-content-wide">
      <div class="overlay-header">
        <h2 id="perimeterOverlayTitle">Perimeter zóny</h2>
        <button id="perimeterOverlayClose" class="overlay-close" aria-label="Zavrieť">&times;</button>
      </div>

      <div class="overlay-body">
        <!-- Perimeter List View -->
        <div id="perimeterListView">
          <!-- Existing Perimeters Section -->
          <div class="perimeter-section">
            <div class="perimeter-section-header">
              <h3>Existujúce zóny</h3>
              <button type="button" id="addNewPerimeter" class="btn-primary btn-small">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="12" y1="5" x2="12" y2="19"/>
                  <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                Pridať zónu
              </button>
            </div>
            <div id="perimeterList" class="perimeter-list">
              <p class="perimeter-loading">Načítavam...</p>
            </div>
          </div>

          <!-- Test Email Section -->
          <div class="perimeter-section test-email-section">
            <h3>Test e-mailovej služby</h3>
            <p class="section-description">Overte, či je e-mailová služba správne nakonfigurovaná odoslaním testovacieho e-mailu.</p>
            <div class="test-email-form">
              <input type="email" id="testEmailAddress" placeholder="Zadajte e-mail pre test" autocomplete="email">
              <button type="button" id="sendTestEmail" class="btn-secondary">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                  <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                  <polyline points="22,6 12,13 2,6"/>
                </svg>
                Odoslať test
              </button>
            </div>
            <p id="testEmailResult" class="test-email-result"></p>
          </div>
        </div>

        <!-- Perimeter Edit/Create View -->
        <div id="perimeterEditView" class="hidden">
          <form id="perimeterForm" novalidate>
            <input type="hidden" id="perimeterId" value="">

            <div class="perimeter-edit-layout">
              <!-- Left column: Form fields -->
              <div class="perimeter-edit-form">
                <div class="perimeter-section">
                  <h3>Základné údaje</h3>

                  <div class="form-row">
                    <label for="perimeterName">Názov perimetra</label>
                    <input type="text" id="perimeterName" placeholder="Napr. Domov, Práca, Škola" autocomplete="off" required>
                  </div>

                  <div class="form-row">
                    <label for="perimeterColor">Farba zóny</label>
                    <input type="color" id="perimeterColor" value="#ff6b6b">
                  </div>
                </div>

                <!-- Multiple Emails Section -->
                <div class="perimeter-section">
                  <h3>E-mailové notifikácie</h3>
                  <p class="section-description">Pridajte e-maily, na ktoré budú posielané upozornenia pri vstupe alebo opustení zóny.</p>
                  <div id="perimeterEmailsList" class="perimeter-emails-list">
                    <!-- Email entries will be added here dynamically -->
                  </div>
                  <button type="button" id="addPerimeterEmail" class="btn-small btn-secondary">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                      <line x1="12" y1="5" x2="12" y2="19"/>
                      <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Pridať e-mail
                  </button>
                </div>
              </div>

              <!-- Right column: Map with trail -->
              <div class="perimeter-edit-map">
                <div class="perimeter-section">
                  <div class="perimeter-map-header">
                    <h3>Nakresliť zónu</h3>
                    <div class="trail-date-selector">
                      <label for="trailDate">Trasa dňa:</label>
                      <input type="date" id="trailDate">
                      <button type="button" id="loadTrailBtn" class="btn-small btn-secondary">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                          <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                          <path d="M3 3v5h5"/>
                        </svg>
                        Načítať
                      </button>
                    </div>
                  </div>
                  <p class="map-help">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                      <circle cx="12" cy="12" r="10"/>
                      <line x1="12" y1="16" x2="12" y2="12"/>
                      <line x1="12" y1="8" x2="12.01" y2="8"/>
                    </svg>
                    Kliknutím na mapu pridaj body polygónu. Pravý klik odstráni bod. Modrá čiara = trasa trackera.
                  </p>
                  <div id="perimeterDrawMap"></div>
                  <div class="polygon-info">
                    <span id="polygonPointCount">Body: 0</span>
                    <button type="button" id="clearPolygon" class="btn-small btn-secondary">Vymazať polygón</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="form-actions perimeter-form-actions">
              <button type="button" id="cancelPerimeterEdit" class="btn-secondary">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"/>
                  <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
                Zrušiť
              </button>
              <button type="button" id="savePerimeter" class="btn-primary">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                  <polyline points="17 21 17 13 7 13 7 21"/>
                  <polyline points="7 3 7 8 15 8"/>
                </svg>
                Uložiť perimeter
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <script src="app.js?v=20251205b" defer></script>
</body>
</html>
