:root{
  --card-bg:#fff;
  --muted-bg:#f7f7f7;
  --border:#e5e5e5;
  --text:#111;
  --muted-text:#555;
  --primary:#0ea5e9;
  --primary-hover:#0284c7;
  --highlight:#10b981;
  --footer-bg:#e5e7eb;
  --battery-good:#10b981;
  --battery-low:#ef4444;
  --body-bg:#f8fafc;
  --btn-bg:#fff;
  --table-hover:#f6faff;
  --table-header-hover:#e8e8e8;
  --table-highlight:#fff3cd;
  --table-prev-day:#f0f9ff;
  --table-prev-day-hover:#dbeafe;
  --table-last-known:#fef3c7;
  --table-last-known-hover:#fed7aa;
  --overlay-backdrop:rgba(0,0,0,0.5);
  --shadow-color:rgba(0,0,0,0.15);
}

/* Dark mode */
[data-theme="dark"]{
  --card-bg:#1e1e1e;
  --muted-bg:#2d2d2d;
  --border:#404040;
  --text:#e5e5e5;
  --muted-text:#a0a0a0;
  --primary:#38bdf8;
  --primary-hover:#0ea5e9;
  --highlight:#34d399;
  --footer-bg:#262626;
  --battery-good:#34d399;
  --battery-low:#f87171;
  --body-bg:#121212;
  --btn-bg:#2d2d2d;
  --table-hover:#252525;
  --table-header-hover:#353535;
  --table-highlight:#3d3520;
  --table-prev-day:#1a2530;
  --table-prev-day-hover:#253545;
  --table-last-known:#3d3520;
  --table-last-known-hover:#4d4530;
  --overlay-backdrop:rgba(0,0,0,0.7);
  --shadow-color:rgba(0,0,0,0.4);
}

/* Auto dark mode based on system preference */
@media (prefers-color-scheme: dark) {
  :root:not([data-theme="light"]) {
    --card-bg:#1e1e1e;
    --muted-bg:#2d2d2d;
    --border:#404040;
    --text:#e5e5e5;
    --muted-text:#a0a0a0;
    --primary:#38bdf8;
    --primary-hover:#0ea5e9;
    --highlight:#34d399;
    --footer-bg:#262626;
    --battery-good:#34d399;
    --battery-low:#f87171;
    --body-bg:#121212;
    --btn-bg:#2d2d2d;
    --table-hover:#252525;
    --table-header-hover:#353535;
    --table-highlight:#3d3520;
    --table-prev-day:#1a2530;
    --table-prev-day-hover:#253545;
    --table-last-known:#3d3520;
    --table-last-known-hover:#4d4530;
    --overlay-backdrop:rgba(0,0,0,0.7);
    --shadow-color:rgba(0,0,0,0.4);
  }
}

/* ========== PIN ENTRY OVERLAY (SECURITY) ========== */
.pin-overlay{
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  z-index:9999;display:flex;align-items:center;justify-content:center;
}

.pin-overlay.hidden{
  display:none;
}

.pin-container{
  background:var(--card-bg);border-radius:20px;
  padding:40px 32px;max-width:400px;width:90%;
  box-shadow:0 20px 60px rgba(0,0,0,0.3);
  animation:slideUp 0.4s ease;
}

.pin-header{
  text-align:center;margin-bottom:32px;
}

.lock-icon{
  width:64px;height:64px;
  color:var(--primary);margin:0 auto 16px;
}

.pin-header h2{
  margin:0 0 8px;font-size:24px;font-weight:700;
  color:var(--text);
}

.pin-header p{
  margin:0;font-size:14px;color:var(--muted-text);
}

/* App Logo/Branding */
.app-logo{
  display:flex;align-items:center;justify-content:center;gap:8px;
  margin-bottom:20px;
}

.app-logo svg{
  color:var(--primary);
}

.app-logo .app-name{
  font-size:22px;font-weight:700;
  background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text;
  letter-spacing:-0.5px;
}

.pin-display{
  display:flex;justify-content:center;gap:16px;
  margin-bottom:24px;
}

.pin-dot{
  width:16px;height:16px;border-radius:50%;
  border:2px solid var(--border);
  background:transparent;
  transition:all 0.3s;
}

.pin-dot.filled{
  background:var(--primary);
  border-color:var(--primary);
  transform:scale(1.2);
}

.pin-error{
  text-align:center;color:#ef4444;
  font-size:14px;font-weight:500;
  margin-bottom:16px;padding:8px;
  background:#fef2f2;border-radius:8px;
  animation:shake 0.4s;
}

.pin-error.hidden{
  display:none;
}

@keyframes shake{
  0%, 100%{transform:translateX(0)}
  25%{transform:translateX(-10px)}
  75%{transform:translateX(10px)}
}

.pin-keypad{
  display:grid;grid-template-columns:repeat(3, 1fr);
  gap:12px;
}

.pin-key{
  width:100%;aspect-ratio:1;
  border:1px solid var(--border);background:var(--btn-bg);
  border-radius:12px;cursor:pointer;
  font-size:24px;font-weight:600;color:var(--text);
  transition:all 0.2s;
  display:flex;align-items:center;justify-content:center;
}

.pin-key:hover:not(.empty){
  background:var(--muted-bg);
  transform:scale(1.05);
}

.pin-key:active:not(.empty){
  transform:scale(0.95);
}

.pin-key.empty{
  background:transparent;border:none;cursor:default;
}

.pin-key.delete{
  background:var(--table-last-known);border-color:var(--battery-low);
  color:var(--battery-low);font-size:18px;
}

.pin-key.delete:hover{
  background:var(--table-last-known-hover);
}

.pin-key svg{
  width:24px;height:24px;
}

/* Mobile responsive PIN pad */
@media (max-width:480px){
  .pin-container{
    padding:32px 24px;
  }

  .lock-icon{
    width:48px;height:48px;
  }

  .pin-header h2{
    font-size:20px;
  }

  .pin-dot{
    width:14px;height:14px;
  }

  .pin-keypad{
    gap:8px;
  }

  .pin-key{
    font-size:20px;
  }
}

*{box-sizing:border-box}
html,body{
  margin:0;min-height:100%;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  color:var(--text);background:var(--body-bg);
}
body{padding:16px 16px 0;display:flex;flex-direction:column}

/* Layout */
.container{
  display:grid;grid-template-columns:1fr;gap:16px;
  max-width:1200px;margin:0 auto;width:100%;flex:1;
  padding-top:70px; /* Space for fixed topbar */
  visibility:hidden; /* Hidden until authenticated */
}

/* Show content only after authentication confirmed */
body.authenticated .container{
  visibility:visible;
}

/* ========== TOPBAR - Flex Layout ========== */
#topbar{
  padding:10px 12px;display:flex;align-items:center;justify-content:space-between;
  background:var(--card-bg);border:1px solid var(--border);border-radius:10px;
  position:fixed;top:8px;left:50%;transform:translateX(-50%);z-index:1100;gap:8px;
  box-shadow:0 2px 8px rgba(0,0,0,0.08);
  width:calc(100% - 32px);max-width:1168px;
}

/* Topbar left - app name */
.topbar-left{
  flex:1;min-width:100px;
}
.topbar-left h1{
  margin:0;font-size:18px;font-weight:700;
  color:var(--text);
  display:flex;align-items:center;gap:6px;
}
.topbar-left h1 svg{
  width:20px;height:20px;stroke:var(--primary);
}

/* ========== SITE NAV SWITCHER (SSO) ========== */
.site-nav{
  position:relative;
}

.site-nav-toggle{
  display:flex;align-items:center;gap:8px;
  background:transparent;border:none;
  cursor:pointer;padding:6px 10px;
  border-radius:8px;
  transition:background-color 0.2s;
}

.site-nav-toggle:hover{
  background:var(--muted-bg);
}

#site-nav-icon{
  font-size:20px;line-height:1;
}

#site-nav-name{
  font-size:17px;font-weight:700;
  color:var(--text);
}

.site-nav-arrow{
  color:var(--muted-text);
  transition:transform 0.2s;
  flex-shrink:0;
}

.site-nav-toggle.active .site-nav-arrow{
  transform:rotate(180deg);
}

/* Site nav dropdown menu */
.site-nav-menu{
  position:absolute;top:calc(100% + 8px);left:0;
  background:var(--card-bg);border:1px solid var(--border);
  border-radius:10px;padding:8px;
  box-shadow:0 4px 16px rgba(0,0,0,0.15);
  z-index:1200;min-width:240px;
  opacity:0;visibility:hidden;
  transform:translateY(-8px);
  transition:opacity 0.2s, visibility 0.2s, transform 0.2s;
}

.site-nav-menu:not(.hidden){
  opacity:1;visibility:visible;
  transform:translateY(0);
}

.site-nav-menu.hidden{
  display:none;
}

.site-nav-loading{
  padding:16px;text-align:center;
  color:var(--muted-text);font-size:13px;
}

.site-nav-item{
  display:flex;align-items:center;gap:12px;
  padding:12px 14px;border-radius:8px;
  text-decoration:none;color:var(--text);
  transition:background-color 0.2s;
  overflow:hidden;
}

.site-nav-item:hover{
  background:var(--muted-bg);
}

.site-nav-item.active{
  background:rgba(14,165,233,0.1);
  border-left:3px solid var(--primary);
}

.site-nav-icon{
  font-size:22px;line-height:1;
  min-width:28px;text-align:center;
}

.site-nav-info{
  display:flex;flex-direction:column;gap:2px;
  flex:1;min-width:0;
}

.site-nav-title{
  font-size:14px;font-weight:600;color:var(--text);
}

.site-nav-desc{
  font-size:11px;color:var(--muted-text);
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}

.site-nav-error{
  padding:12px;text-align:center;
  color:#ef4444;font-size:12px;
}

/* Topbar center - date controls */
.topbar-center{
  display:flex;align-items:center;gap:8px;flex-wrap:wrap;
  position:relative;justify-content:center;
}

/* Topbar right - last online + battery + hamburger */
.topbar-right{
  flex:1;min-width:100px;display:flex;align-items:center;gap:12px;
  justify-content:flex-end;
}

/* TlaÄidlÃ¡ v topbar */
#topbar button{
  padding:6px 10px;border:1px solid var(--border);background:var(--btn-bg);border-radius:8px;cursor:pointer;
  white-space:nowrap;color:var(--text);
}
#topbar button:hover{background:var(--muted-bg)}
#topbar button:focus-visible{outline:2px solid var(--primary);outline-offset:2px}
#topbar button:disabled{opacity:0.5;cursor:not-allowed}
#topbar button:disabled:hover{background:var(--btn-bg)}

/* Calendar toggle button */
#calendarToggle{
  padding:6px 12px;display:flex;align-items:center;gap:6px;
  font-weight:600;min-width:140px;justify-content:space-between;
}
.dropdown-icon{font-size:10px;opacity:0.6}

#currentDate{display:inline-block;text-align:center}

/* ========== LAST ONLINE INDICATOR ========== */
.last-online-info{
  display:flex;align-items:center;gap:6px;
  padding:6px 10px;background:var(--muted-bg);border-radius:8px;
  border:1px solid var(--border);
  transition:border-color 0.3s, background-color 0.3s;
}

.last-online-info[data-status="online"]{
  border-color:var(--battery-good);
  background:rgba(16, 185, 129, 0.1);
}

.last-online-info[data-status="offline"]{
  border-color:var(--battery-low);
  background:rgba(239, 68, 68, 0.1);
}

.last-online-info[data-source="cache"]{
  opacity:0.8;
}

.clock-icon{
  width:18px;height:18px;
  color:var(--muted-text);
  flex-shrink:0;
  transition:color 0.3s;
}

.last-online-info[data-status="online"] .clock-icon{
  color:var(--battery-good);
}

.last-online-info[data-status="offline"] .clock-icon{
  color:var(--battery-low);
}

#lastOnlineText{
  font-size:12px;font-weight:500;
  color:var(--text);white-space:nowrap;
}

/* ========== BATTERY INDICATOR ========== */
.battery-indicator{
  display:flex;align-items:center;gap:6px;
  padding:6px 10px;background:var(--muted-bg);border-radius:8px;
  border:1px solid var(--border);
  transition:border-color 0.3s, background-color 0.3s;
}

.battery-indicator[data-level="good"]{
  border-color:var(--battery-good);
  background:rgba(16, 185, 129, 0.1);
}

.battery-indicator[data-level="low"]{
  border-color:var(--battery-low);
  background:rgba(239, 68, 68, 0.1);
}

.battery-icon-good,
.battery-icon-low{
  width:22px;height:22px;
  flex-shrink:0;
}

.battery-icon-good{
  color:var(--battery-good);
}

.battery-icon-low{
  color:var(--battery-low);
}

/* Show/hide icons based on state */
.battery-indicator .battery-icon-good,
.battery-indicator .battery-icon-low{
  display:none;
}

.battery-indicator[data-level="good"] .battery-icon-good{
  display:block;
}

.battery-indicator[data-level="low"] .battery-icon-low{
  display:block;
}

.battery-text{
  font-size:13px;font-weight:600;
  color:var(--text);min-width:40px;text-align:left;
  display:none;
}

/* ========== USER NAME DISPLAY ========== */
.user-name-display{
  font-size:13px;font-weight:500;
  color:var(--text);
  padding:6px 10px;
  background:var(--muted-bg);
  border:1px solid var(--border);
  border-radius:8px;
  white-space:nowrap;
  max-width:120px;
  overflow:hidden;
  text-overflow:ellipsis;
}

.user-name-display.hidden{
  display:none;
}

/* ========== HAMBURGER CONTAINER ========== */
.hamburger-container{
  position:relative;
}

.hamburger-btn{
  width:40px;height:40px;display:flex;flex-direction:column;
  justify-content:center;align-items:center;gap:5px;
  background:var(--muted-bg);border:1px solid var(--border);
  border-radius:8px;cursor:pointer;padding:8px;
  transition:background-color 0.2s;
}

.hamburger-btn:hover{
  background:#e5e5e5;
}

.hamburger-btn span{
  display:block;width:20px;height:2px;
  background:var(--text);border-radius:2px;
  transition:all 0.3s ease;
}

.hamburger-btn.active span:nth-child(1){
  transform:rotate(45deg) translate(5px, 5px);
}

.hamburger-btn.active span:nth-child(2){
  opacity:0;
}

.hamburger-btn.active span:nth-child(3){
  transform:rotate(-45deg) translate(7px, -7px);
}

/* ========== HAMBURGER MENU DROPDOWN ========== */
.hamburger-menu{
  position:absolute;top:calc(100% + 8px);right:0;
  background:var(--card-bg);border:1px solid var(--border);
  border-radius:10px;padding:8px;
  box-shadow:0 4px 12px rgba(0,0,0,0.15);
  z-index:1200;min-width:220px;
}

.hamburger-menu.hidden{
  display:none;
}

.menu-item{
  width:100%;padding:12px 16px;
  display:flex;align-items:center;gap:12px;
  background:transparent;border:none;
  border-radius:6px;cursor:pointer;
  font-size:14px;color:var(--text);
  text-align:left;transition:background-color 0.2s;
}

.menu-item:hover{
  background:var(--muted-bg);
}

.menu-item svg{
  width:20px;height:20px;
  flex-shrink:0;
}

/* Submenu styles */
.menu-submenu{
  width:100%;
}

.menu-parent{
  justify-content:flex-start;
}

.menu-parent .submenu-arrow{
  width:16px;height:16px;
  margin-left:auto;
  transition:transform 0.2s;
}

.menu-parent.expanded .submenu-arrow{
  transform:rotate(180deg);
}

.submenu-items{
  padding-left:16px;
  overflow:hidden;
  transition:max-height 0.2s ease;
}

.submenu-items.hidden{
  display:none;
}

.submenu-item{
  font-size:13px;
  padding:10px 16px;
}

.submenu-item svg{
  width:16px;height:16px;
}

/* Calendar dropdown */
.calendar-dropdown{
  position:absolute;top:calc(100% + 4px);left:50%;
  transform:translateX(-50%);
  background:var(--card-bg);border:1px solid var(--border);
  border-radius:10px;padding:12px;
  box-shadow:0 4px 12px rgba(0,0,0,0.1);
  z-index:1200;min-width:280px;
}
.calendar-dropdown.hidden{display:none}

.calendar-header{
  display:flex;justify-content:space-between;align-items:center;
  margin-bottom:12px;padding:4px 0;
}
.calendar-header button{
  padding:4px 8px;border:1px solid var(--border);background:var(--btn-bg);
  border-radius:6px;cursor:pointer;font-size:16px;color:var(--text);
}
.calendar-header button:hover{background:var(--muted-bg)}
.calendar-header span{font-weight:600;font-size:14px}

.calendar-grid{
  display:grid;grid-template-columns:repeat(7,1fr);gap:4px;
}
.calendar-day{
  padding:8px 4px;text-align:center;border-radius:6px;
  cursor:pointer;font-size:13px;border:1px solid transparent;
}
.calendar-day.header{
  font-weight:600;font-size:11px;color:var(--muted-text);
  cursor:default;padding:4px;
}
.calendar-day.empty{cursor:default;background:transparent}
.calendar-day.active:not(.header){background:var(--muted-bg);border-color:var(--border)}
.calendar-day.has-data:not(.header){
  background:var(--highlight);color:#fff;font-weight:600;
}
.calendar-day.today:not(.header){
  border:2px solid var(--primary);font-weight:600;
}
.calendar-day.selected:not(.header){
  background:var(--primary);color:#fff;font-weight:600;
}
.calendar-day:not(.header):not(.empty):hover{
  background:var(--primary-hover);color:#fff;
}

/* ========== OVERLAY ========== */
.overlay{
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:var(--overlay-backdrop);z-index:2000;
  display:flex;align-items:center;justify-content:center;
  animation:fadeIn 0.2s ease;
}

.overlay.hidden{
  display:none;
}

@keyframes fadeIn{
  from{opacity:0}
  to{opacity:1}
}

.overlay-content{
  background:var(--card-bg);border-radius:12px;
  max-width:600px;width:90%;max-height:90vh;
  overflow-y:auto;box-shadow:0 8px 24px rgba(0,0,0,0.2);
  animation:slideUp 0.3s ease;
  -webkit-overflow-scrolling:touch; /* Smooth scrolling on iOS */
  overscroll-behavior:contain; /* Prevent scroll chaining */
}

@keyframes slideUp{
  from{transform:translateY(20px);opacity:0}
  to{transform:translateY(0);opacity:1}
}

.overlay-header{
  padding:20px 24px;border-bottom:1px solid var(--border);
  display:flex;justify-content:space-between;align-items:center;
  background:var(--muted-bg);border-radius:12px 12px 0 0;
}

.overlay-header h2{
  margin:0;font-size:20px;font-weight:600;
}

.overlay-close{
  background:transparent;border:none;
  font-size:32px;line-height:1;cursor:pointer;
  color:var(--muted-text);padding:0;
  width:32px;height:32px;display:flex;align-items:center;
  justify-content:center;border-radius:6px;
  transition:background-color 0.2s;
}

.overlay-close:hover{
  background:var(--muted-bg);
  color:var(--text);
}

.overlay-body{
  padding:24px;
}

/* ========== FORM STYLES ========== */
#ibeaconForm{
  display:grid;gap:16px;grid-template-columns:1fr 1fr;
}

#ibeaconForm label{
  display:flex;flex-direction:column;font-size:13px;
  color:var(--muted-text);font-weight:500;
}

#ibeaconForm input{
  padding:10px 12px;border:1px solid var(--border);
  border-radius:8px;font-size:14px;width:100%;
  margin-top:6px;transition:border-color 0.2s;
}

#ibeaconForm input:focus{
  outline:none;border-color:var(--primary);
  box-shadow:0 0 0 3px rgba(14,165,233,0.1);
}

.form-actions{
  grid-column:1/-1;display:flex;gap:8px;
  align-items:center;margin-top:8px;
}

.btn-primary{
  padding:10px 20px;border:none;background:var(--primary);
  color:#fff;border-radius:8px;cursor:pointer;font-weight:500;
  transition:background-color 0.2s;display:flex;align-items:center;gap:8px;
}

.btn-primary:hover{
  background:var(--primary-hover);
}

.btn-primary svg{
  width:18px;height:18px;
}

.btn-secondary{
  padding:10px 20px;border:1px solid var(--border);
  background:var(--btn-bg);border-radius:8px;cursor:pointer;
  color:var(--text);font-weight:500;
  transition:all 0.2s;display:flex;align-items:center;gap:8px;
}

.btn-secondary:hover{
  background:var(--muted-bg);
}

.btn-secondary svg{
  width:18px;height:18px;
}

/* ========== MAP SELECTOR ========== */
.map-selector{
  margin-top:20px;
}

.map-selector.hidden{
  display:none;
}

.map-help{
  margin:0 0 12px;padding:12px;
  background:#eff6ff;border:1px solid #bfdbfe;
  border-radius:8px;color:#1e40af;font-size:13px;
}

#selectorMap{
  height:400px;border-radius:8px;
  border:1px solid var(--border);
}

.map-actions{
  margin-top:12px;display:flex;gap:8px;
}

/* ========== IBEACON LIST ========== */
#ibeaconList{
  padding:0;
}

#ibeaconList .row{
  display:flex;gap:12px;align-items:center;
  padding:16px;border-bottom:1px solid var(--border);
  background:var(--muted-bg);border-radius:8px;margin-bottom:8px;
  transition:background-color 0.2s;
}

#ibeaconList .row:hover{
  background:var(--table-hover);
}

#ibeaconList .row:last-child{
  margin-bottom:0;
}

#ibeaconList .info{
  flex:1;min-width:0;
}

#ibeaconList .info strong{
  display:block;font-size:15px;margin-bottom:4px;
}

#ibeaconList .info small{
  display:block;color:var(--muted-text);font-size:12px;
  margin-top:2px;
}

#ibeaconList .actions{
  display:flex;gap:8px;flex-shrink:0;
}

#ibeaconList .btn-edit,
#ibeaconList .btn-delete{
  padding:6px 12px;border:1px solid var(--border);
  border-radius:6px;cursor:pointer;font-size:13px;
  transition:all 0.2s;
}

#ibeaconList .btn-edit{
  background:var(--btn-bg);color:var(--primary);border-color:var(--primary);
}

#ibeaconList .btn-edit:hover{
  background:var(--primary);color:#fff;
}

#ibeaconList .btn-delete{
  background:#ef4444;color:#fff;border-color:#ef4444;
}

#ibeaconList .btn-delete:hover{
  filter:brightness(0.9);
}

/* Map */
.map-wrap{position:relative}
#map{
  height:60vh;width:100%;
  border-radius:10px;border:1px solid var(--border);background:var(--card-bg);
}

/* Blinking marker animation */
@keyframes blink {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.3; transform: scale(1.3); }
}

.leaflet-marker-icon.blinking {
  animation: blink 1.5s ease-in-out infinite;
}

/* Ensure animation works for divIcon content */
.leaflet-marker-icon div[style*="animation"] {
  display: block;
}

/* Spinner animation */
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.spin {
  animation: spin 1s linear infinite;
}

/* Table wrapper */
#positionsTable{
  background:var(--card-bg);border:1px solid var(--border);border-radius:10px;
  padding:10px;overflow:hidden;
  display:flex;flex-direction:column;
  max-height:700px;
}

#positionsTable .pos-table{
  width:100%;border-collapse:collapse;font-size:14px;min-width:820px;
  display:block;
}

#positionsTable thead{
  display:table;width:100%;table-layout:fixed;
}

#positionsTable tbody{
  display:block;width:100%;
  max-height:615px;
  overflow-y:auto;
  overflow-x:hidden;
}

#positionsTable tbody tr{
  display:table;width:100%;table-layout:fixed;
}

#positionsTable th,#positionsTable td{
  padding:8px 10px;border-bottom:1px solid var(--border);text-align:left;white-space:nowrap;
}
#positionsTable thead th{
  background:var(--muted-bg);position:sticky;top:0;z-index:1;cursor:pointer;
  user-select:none;
}
#positionsTable tbody tr{cursor:pointer;transition:background-color 0.2s}
#positionsTable tbody tr:hover{background:var(--table-hover)}
#positionsTable tbody tr.highlighted{background:var(--table-highlight);border-left:3px solid #ff6b00}
#positionsTable tbody tr.prev-day-row{background:var(--table-prev-day);font-style:italic}
#positionsTable tbody tr.prev-day-row:hover{background:var(--table-prev-day-hover)}
#positionsTable tbody tr.last-known-row{background:var(--table-last-known);border-left:3px solid #ff9800}
#positionsTable tbody tr.last-known-row:hover{background:var(--table-last-known-hover)}

/* Sort indicators */
#positionsTable th.sortable:hover{background:var(--table-header-hover)}
#positionsTable th.sort-asc::after{content:" â–²";font-size:12px}
#positionsTable th.sort-desc::after{content:" â–¼";font-size:12px}

/* Leaflet legend - collapsible */
.custom-legend-container{
  display:flex;flex-direction:column;align-items:flex-end;gap:8px;
}

.legend-toggle-btn{
  width:40px;height:40px;
  background:var(--card-bg);border:1px solid var(--border);border-radius:10px;
  box-shadow:0 4px 16px var(--shadow-color);
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  transition:all 0.3s;color:var(--text);
  order:2;
}
.legend-toggle-btn:hover{background:var(--muted-bg);transform:scale(1.05);}
.legend-toggle-btn.active{background:var(--primary);color:#fff;}

.legend-content{
  background:var(--card-bg);border:1px solid var(--border);border-radius:10px;
  box-shadow:0 4px 16px var(--shadow-color);
  padding:10px 12px;font-size:13px;line-height:1.25;
  transition:all 0.3s ease;transform-origin:bottom right;
  opacity:1;transform:scale(1);
  order:1;
  margin-bottom:0;
}
.legend-content.hidden{
  opacity:0;transform:scale(0.8);pointer-events:none;
  display:none;
}

.legend-header{
  font-weight:600;margin-bottom:6px;padding-bottom:4px;
  border-bottom:1px solid var(--border);
}

.leaflet-control.custom-legend-container .leg-item{display:flex;align-items:center;gap:8px;margin:4px 0}
.leaflet-control.custom-legend-container .leg-dot{width:12px;height:12px;border-radius:50%;display:inline-block}
.leaflet-control.custom-legend-container .leg-dot.blue{background:#3388ff}
.leaflet-control.custom-legend-container .leg-dot.red{background:#ff3b30}
.leaflet-control.custom-legend-container .leg-dot.blinking{
  background:#3388ff;
  animation: blink 1.5s ease-in-out infinite;
}
.leaflet-control.custom-legend-container .leg-line{width:18px;height:3px;background:#3388ff;border-radius:2px;display:inline-block}

/* ========== SETTINGS OVERLAY ========== */
.settings-content{
  max-width:800px;
}

#settingsForm{
  display:flex;flex-direction:column;gap:24px;
}

.setting-group{
  padding:20px;background:var(--muted-bg);border-radius:10px;
  border:1px solid var(--border);
}

.setting-header{
  display:flex;justify-content:space-between;align-items:flex-start;
  margin-bottom:8px;gap:12px;
}

.setting-header label{
  flex:1;display:flex;flex-direction:column;gap:4px;
}

.setting-header label strong{
  font-size:15px;color:var(--text);
}

.setting-current{
  font-size:12px;color:var(--primary);font-weight:600;
}

.btn-default{
  padding:6px 12px;border:1px solid var(--border);
  background:var(--btn-bg);border-radius:6px;cursor:pointer;
  font-size:12px;color:var(--muted-text);
  transition:all 0.2s;white-space:nowrap;
  flex-shrink:0;
}

.btn-default:hover{
  background:var(--primary);color:#fff;
  border-color:var(--primary);
}

.setting-description{
  font-size:13px;color:var(--muted-text);
  line-height:1.5;margin-bottom:12px;
}

.setting-input-group{
  display:flex;align-items:center;gap:8px;flex-wrap:wrap;
}

.setting-input-group input[type="number"]{
  padding:10px 12px;border:1px solid var(--border);
  border-radius:8px;font-size:14px;width:120px;
  transition:border-color 0.2s;
  background:var(--btn-bg);color:var(--text);
}

.setting-input-group input[type="number"]:focus{
  outline:none;border-color:var(--primary);
  box-shadow:0 0 0 3px rgba(14,165,233,0.1);
}

.setting-unit{
  font-size:13px;color:var(--muted-text);font-weight:500;
}

.setting-range{
  font-size:12px;color:#999;font-style:italic;
}

/* Theme Toggle Group */
.theme-toggle-group{
  display:flex;gap:8px;flex-wrap:wrap;
}

.theme-option{
  cursor:pointer;
}

.theme-option input[type="radio"]{
  display:none;
}

.theme-label{
  display:flex;align-items:center;gap:6px;
  padding:10px 16px;border-radius:8px;
  border:2px solid var(--border);
  background:var(--card-bg);
  font-size:14px;font-weight:500;
  color:var(--text);
  transition:border-color 0.2s, background-color 0.2s;
}

.theme-label svg{
  width:18px;height:18px;
}

.theme-option input[type="radio"]:checked + .theme-label{
  border-color:var(--primary);
  background:rgba(14,165,233,0.1);
}

.theme-option:hover .theme-label{
  border-color:var(--muted-text);
}

/* Toggle Switch */
.toggle-switch{
  display:inline-block;position:relative;
}

.toggle-switch input[type="checkbox"]{
  display:none;
}

.toggle-label{
  display:flex;align-items:center;cursor:pointer;
  width:56px;height:28px;background:var(--border);
  border-radius:28px;position:relative;
  transition:background-color 0.3s;
}

.toggle-inner{
  content:'';position:absolute;width:22px;height:22px;
  background:var(--card-bg);border-radius:50%;
  top:3px;left:3px;
  transition:transform 0.3s;
  box-shadow:0 2px 4px rgba(0,0,0,0.2);
}

.toggle-switch input:checked + .toggle-label{
  background:var(--highlight);
}

.toggle-switch input:checked + .toggle-label .toggle-inner{
  transform:translateX(28px);
}

.toggle-switch-text{
  margin-left:64px;font-size:13px;color:var(--text);
}

/* Reset all button */
.btn-reset{
  padding:10px 20px;border:1px solid #ef4444;
  background:#fff;border-radius:8px;cursor:pointer;
  color:#ef4444;font-weight:500;
  transition:all 0.2s;display:flex;align-items:center;gap:8px;
}

.btn-reset:hover{
  background:#ef4444;color:#fff;
}

.btn-reset svg{
  width:18px;height:18px;
}

/* ========== PERIMETER MANAGEMENT ========== */
.perimeter-content{
  max-width:700px;
}

.perimeter-content-wide{
  max-width:1000px;
  width:95%;
}

.perimeter-section{
  background:var(--muted-bg);
  border:1px solid var(--border);
  border-radius:10px;
  padding:20px;
  margin-bottom:16px;
}

.perimeter-section:last-child{
  margin-bottom:0;
}

.perimeter-section h3{
  margin:0 0 12px;
  font-size:16px;
  font-weight:600;
  color:var(--text);
}

.perimeter-section-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:16px;
}

.perimeter-section-header h3{
  margin:0;
}

.section-description{
  margin:0 0 16px;
  font-size:13px;
  color:var(--muted-text);
  line-height:1.5;
}

/* Perimeter Edit Layout - Two columns */
.perimeter-edit-layout{
  display:grid;
  grid-template-columns:1fr 1.5fr;
  gap:20px;
}

.perimeter-edit-form{
  display:flex;
  flex-direction:column;
  gap:16px;
}

.perimeter-edit-map .perimeter-section{
  height:100%;
  display:flex;
  flex-direction:column;
}

.perimeter-edit-map #perimeterDrawMap{
  flex:1;
  min-height:400px;
}

.perimeter-map-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  flex-wrap:wrap;
  gap:12px;
  margin-bottom:12px;
}

.perimeter-map-header h3{
  margin:0;
}

.trail-date-selector{
  display:flex;
  align-items:center;
  gap:8px;
}

.trail-date-selector label{
  font-size:13px;
  color:var(--muted-text);
  white-space:nowrap;
}

.trail-date-selector input[type="date"]{
  padding:6px 10px;
  border:1px solid var(--border);
  border-radius:6px;
  font-size:13px;
  background:var(--btn-bg);
  color:var(--text);
}

.perimeter-form-actions{
  margin-top:20px;
  padding-top:16px;
  border-top:1px solid var(--border);
  justify-content:flex-end;
}

/* ========== Settings - Select ========== */
.setting-select{
  padding:8px 12px;
  border:1px solid var(--border);
  border-radius:6px;
  background:var(--btn-bg);
  color:var(--text);
  font-size:14px;
  min-width:200px;
  cursor:pointer;
}

.setting-select:focus{
  outline:none;
  border-color:var(--primary);
  box-shadow:0 0 0 2px var(--primary-alpha);
}

/* ========== Log Viewer ========== */
.log-viewer-content{
  width:95%;
  max-width:1000px;
  max-height:90vh;
}

.log-section{
  margin-bottom:24px;
}

.log-section-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  flex-wrap:wrap;
  gap:12px;
  margin-bottom:12px;
}

.log-section-header h3{
  margin:0;
  font-size:16px;
}

.stats-period-selector{
  display:flex;
  align-items:center;
  gap:8px;
}

.stats-period-selector label{
  font-size:13px;
  color:var(--muted-text);
}

.stats-select{
  padding:6px 10px;
  border:1px solid var(--border);
  border-radius:6px;
  font-size:13px;
  background:var(--btn-bg);
  color:var(--text);
  cursor:pointer;
}

/* Stats Grid */
.log-stats-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit, minmax(140px, 1fr));
  gap:12px;
}

.stat-card{
  background:var(--btn-bg);
  border:1px solid var(--border);
  border-radius:8px;
  padding:16px;
  text-align:center;
}

.stat-card-wide{
  grid-column:span 2;
}

.stat-icon{
  width:32px;
  height:32px;
  margin:0 auto 8px;
  border-radius:8px;
  display:flex;
  align-items:center;
  justify-content:center;
}

.stat-icon svg{
  width:18px;
  height:18px;
}

.stat-icon-fetch{
  background:#eef2ff;
  color:#4f46e5;
}

.stat-icon-google{
  background:#fef3c7;
  color:#d97706;
}

.stat-icon-positions{
  background:#d1fae5;
  color:#059669;
}

.stat-icon-cache{
  background:#dbeafe;
  color:#2563eb;
}

.stat-icon-ibeacon{
  background:#fce7f3;
  color:#db2777;
}

.stat-icon-perimeter{
  background:#fee2e2;
  color:#dc2626;
}

.stat-icon-logs{
  background:#f3f4f6;
  color:#6b7280;
}

[data-theme="dark"] .stat-icon-fetch{
  background:#312e81;
  color:#a5b4fc;
}

[data-theme="dark"] .stat-icon-google{
  background:#78350f;
  color:#fcd34d;
}

[data-theme="dark"] .stat-icon-positions{
  background:#064e3b;
  color:#6ee7b7;
}

[data-theme="dark"] .stat-icon-cache{
  background:#1e3a8a;
  color:#93c5fd;
}

[data-theme="dark"] .stat-icon-ibeacon{
  background:#831843;
  color:#f9a8d4;
}

[data-theme="dark"] .stat-icon-perimeter{
  background:#7f1d1d;
  color:#fca5a5;
}

[data-theme="dark"] .stat-icon-logs{
  background:#374151;
  color:#d1d5db;
}

.stat-value{
  font-size:24px;
  font-weight:700;
  color:var(--text);
  margin-bottom:4px;
}

.stat-label{
  font-size:12px;
  color:var(--muted-text);
}

.stat-detail{
  font-size:11px;
  color:var(--muted-text);
  margin-top:4px;
}

.stat-counts{
  display:flex;
  justify-content:center;
  gap:12px;
  margin-bottom:8px;
}

.log-count{
  font-size:13px;
  font-weight:600;
  padding:4px 8px;
  border-radius:4px;
}

.log-count-error{
  background:#fee2e2;
  color:#dc2626;
}

.log-count-info{
  background:#dbeafe;
  color:#2563eb;
}

.log-count-debug{
  background:#f3f4f6;
  color:#6b7280;
}

[data-theme="dark"] .log-count-error{
  background:#7f1d1d;
  color:#fca5a5;
}

[data-theme="dark"] .log-count-info{
  background:#1e3a8a;
  color:#93c5fd;
}

[data-theme="dark"] .log-count-debug{
  background:#374151;
  color:#d1d5db;
}

/* Log Controls */
.log-controls{
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  align-items:center;
}

.log-filter-group{
  display:flex;
  gap:8px;
  flex:1;
  min-width:200px;
}

.log-filter-select{
  padding:6px 10px;
  border:1px solid var(--border);
  border-radius:6px;
  font-size:13px;
  background:var(--btn-bg);
  color:var(--text);
  min-width:120px;
}

.log-search-input{
  flex:1;
  padding:6px 12px;
  border:1px solid var(--border);
  border-radius:6px;
  font-size:13px;
  background:var(--btn-bg);
  color:var(--text);
}

.log-search-input::placeholder{
  color:var(--muted-text);
}

.log-action-buttons{
  display:flex;
  gap:8px;
}

.log-info-bar{
  display:flex;
  justify-content:space-between;
  font-size:12px;
  color:var(--muted-text);
  margin-bottom:8px;
  padding:8px 12px;
  background:var(--btn-bg);
  border-radius:6px;
}

/* Log Container */
.log-container{
  background:var(--card-bg);
  border:1px solid var(--border);
  border-radius:8px;
  max-height:400px;
  overflow-y:auto;
  font-family:'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace;
  font-size:12px;
}

.log-loading,
.log-empty{
  padding:40px;
  text-align:center;
  color:var(--muted-text);
}

.log-entry{
  display:flex;
  gap:12px;
  padding:8px 12px;
  border-bottom:1px solid var(--border);
  align-items:flex-start;
}

.log-entry:last-child{
  border-bottom:none;
}

.log-entry:hover{
  background:var(--btn-bg);
}

.log-time{
  color:var(--muted-text);
  white-space:nowrap;
  min-width:150px;
}

.log-level{
  font-weight:600;
  min-width:50px;
  text-align:center;
  padding:2px 6px;
  border-radius:4px;
  font-size:10px;
}

.log-level-error .log-level{
  background:#fee2e2;
  color:#dc2626;
}

.log-level-info .log-level{
  background:#dbeafe;
  color:#2563eb;
}

.log-level-debug .log-level{
  background:#f3f4f6;
  color:#6b7280;
}

[data-theme="dark"] .log-level-error .log-level{
  background:#7f1d1d;
  color:#fca5a5;
}

[data-theme="dark"] .log-level-info .log-level{
  background:#1e3a8a;
  color:#93c5fd;
}

[data-theme="dark"] .log-level-debug .log-level{
  background:#374151;
  color:#d1d5db;
}

.log-message{
  flex:1;
  word-break:break-word;
  color:var(--text);
}

/* Log Pagination */
.log-pagination{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:16px;
  margin-top:12px;
  padding-top:12px;
  border-top:1px solid var(--border);
}

#logPageInfo{
  font-size:13px;
  color:var(--muted-text);
}

/* Responsive - stack columns on mobile */
@media (max-width:768px){
  .perimeter-edit-layout{
    grid-template-columns:1fr;
  }

  .perimeter-content-wide{
    max-width:95%;
  }

  .perimeter-map-header{
    flex-direction:column;
    align-items:flex-start;
  }

  .trail-date-selector{
    width:100%;
  }

  .trail-date-selector input[type="date"]{
    flex:1;
  }

  /* Log Viewer responsive */
  .log-viewer-content{
    max-width:98%;
  }

  .log-section-header{
    flex-direction:column;
    align-items:flex-start;
  }

  .stats-period-selector{
    width:100%;
  }

  .log-stats-grid{
    grid-template-columns:repeat(2, 1fr);
  }

  .stat-card-wide{
    grid-column:span 2;
  }

  .log-controls{
    flex-direction:column;
    align-items:stretch;
  }

  .log-filter-group{
    flex-direction:column;
    min-width:0;
  }

  .log-filter-select{
    width:100%;
  }

  .log-action-buttons{
    justify-content:flex-end;
  }

  .log-container{
    max-height:300px;
  }

  .log-entry{
    flex-direction:column;
    gap:4px;
  }

  .log-time{
    font-size:11px;
    min-width:auto;
  }

  .log-level{
    align-self:flex-start;
  }
}

.perimeter-actions-top{
  margin-bottom:16px;
}

.perimeter-list{
  display:flex;flex-direction:column;gap:12px;
}

.perimeter-loading{
  color:var(--muted-text);padding:20px;text-align:center;
}

.perimeter-item{
  display:flex;gap:12px;align-items:center;
  padding:16px;background:var(--muted-bg);
  border:1px solid var(--border);border-radius:10px;
  transition:all 0.2s;
}

.perimeter-item:hover{
  border-color:var(--primary);
}

.perimeter-item.inactive{
  opacity:0.6;
}

.perimeter-color{
  width:16px;height:16px;border-radius:4px;
  flex-shrink:0;border:1px solid rgba(0,0,0,0.1);
}

.perimeter-info{
  flex:1;min-width:0;
}

.perimeter-info h4{
  margin:0 0 4px;font-size:15px;font-weight:600;
}

.perimeter-info small{
  display:block;color:var(--muted-text);font-size:12px;
}

.perimeter-badges{
  display:flex;gap:6px;margin-top:6px;flex-wrap:wrap;
}

.perimeter-badge{
  display:inline-flex;align-items:center;gap:4px;
  padding:2px 8px;font-size:11px;border-radius:12px;
  background:#e5e7eb;color:#374151;
}

.perimeter-badge.enter{background:#d1fae5;color:#065f46;}
.perimeter-badge.exit{background:#fee2e2;color:#991b1b;}
.perimeter-badge.inactive{background:#fef3c7;color:#92400e;}

.perimeter-actions{
  display:flex;gap:8px;flex-shrink:0;
}

.perimeter-actions button{
  padding:6px 12px;border-radius:6px;cursor:pointer;
  font-size:12px;transition:all 0.2s;
  display:flex;align-items:center;gap:4px;
}

.perimeter-actions .btn-toggle{
  background:var(--btn-bg);border:1px solid var(--border);color:var(--text);
}
.perimeter-actions .btn-toggle:hover{background:var(--muted-bg);}

.perimeter-actions .btn-edit{
  background:var(--btn-bg);border:1px solid var(--primary);color:var(--primary);
}
.perimeter-actions .btn-edit:hover{background:var(--primary);color:#fff;}

.perimeter-actions .btn-delete{
  background:#ef4444;border:1px solid #ef4444;color:#fff;
}
.perimeter-actions .btn-delete:hover{filter:brightness(0.9);}

/* Perimeter Form */
#perimeterForm{
  display:flex;flex-direction:column;gap:16px;
}

#perimeterForm .form-row{
  display:flex;flex-direction:column;gap:4px;
}

#perimeterForm .form-row label{
  font-size:13px;font-weight:500;color:var(--muted-text);
}

#perimeterForm .form-row input[type="text"],
#perimeterForm .form-row input[type="email"]{
  padding:10px 12px;border:1px solid var(--border);
  border-radius:8px;font-size:14px;width:100%;
  transition:border-color 0.2s;
  background:var(--btn-bg);color:var(--text);
}

#perimeterForm .form-row input:focus{
  outline:none;border-color:var(--primary);
  box-shadow:0 0 0 3px rgba(14,165,233,0.1);
}

#perimeterForm .form-row input[type="color"]{
  width:60px;height:36px;padding:2px;
  border:1px solid var(--border);border-radius:6px;
  cursor:pointer;
}

.form-row-inline{
  flex-direction:row !important;gap:24px !important;
  flex-wrap:wrap;
}

.checkbox-group{
  display:flex;align-items:center;
}

.checkbox-label{
  display:flex;align-items:center;gap:8px;
  cursor:pointer;font-size:14px;color:var(--text);
}

.checkbox-label input[type="checkbox"]{
  width:18px;height:18px;cursor:pointer;
  accent-color:var(--primary);
}

/* Multiple Emails List */
.perimeter-emails-list{
  display:flex;flex-direction:column;gap:10px;
  margin-bottom:12px;
}

.perimeter-email-entry{
  display:flex;flex-wrap:wrap;gap:8px;
  padding:12px;background:var(--muted-bg);
  border-radius:8px;border:1px solid var(--border);
}

.perimeter-email-entry input[type="email"]{
  flex:1;min-width:180px;padding:8px 12px;
  border:1px solid var(--border);border-radius:6px;
  font-size:14px;background:var(--surface);color:var(--text);
}

.perimeter-email-entry input[type="email"]:focus{
  outline:none;border-color:var(--primary);
}

.perimeter-email-options{
  display:flex;align-items:center;gap:12px;flex-wrap:wrap;
}

.perimeter-email-options .checkbox-label{
  font-size:12px;gap:4px;
}

.perimeter-email-options .checkbox-label input[type="checkbox"]{
  width:16px;height:16px;
}

.btn-remove-email{
  padding:6px 10px;background:#fee2e2;color:#991b1b;
  border:1px solid #fca5a5;border-radius:6px;
  cursor:pointer;font-size:12px;
  display:flex;align-items:center;gap:4px;
}

.btn-remove-email:hover{
  background:#fecaca;
}

.perimeter-emails-empty{
  padding:16px;text-align:center;
  color:var(--muted-text);font-size:13px;
  background:var(--muted-bg);border-radius:8px;
  border:1px dashed var(--border);
}

/* Perimeter Map */
.perimeter-map-section{
  margin-top:8px;
}

.perimeter-map-section .map-help{
  display:flex;align-items:center;gap:8px;
  margin:0 0 12px;padding:12px;
  background:#eff6ff;border:1px solid #bfdbfe;
  border-radius:8px;color:#1e40af;font-size:13px;
}

#perimeterDrawMap{
  height:350px;border-radius:8px;
  border:1px solid var(--border);
}

.polygon-info{
  display:flex;align-items:center;justify-content:space-between;
  margin-top:12px;padding:8px 12px;
  background:var(--muted-bg);border-radius:6px;
}

#polygonPointCount{
  font-size:13px;font-weight:500;color:var(--text);
}

.btn-small{
  padding:6px 12px !important;font-size:12px !important;
}

/* Test Email Section */
.test-email-section{
  margin-top:24px;padding-top:20px;
  border-top:1px solid var(--border);
}

.test-email-section h4{
  margin:0 0 12px;font-size:14px;font-weight:600;color:var(--text);
}

.test-email-form{
  display:flex;gap:10px;flex-wrap:wrap;
}

.test-email-form input{
  flex:1;min-width:200px;padding:10px 14px;
  border:1px solid var(--border);border-radius:8px;
  font-size:14px;background:var(--surface);color:var(--text);
}

.test-email-form input:focus{
  outline:none;border-color:var(--primary);
  box-shadow:0 0 0 3px rgba(59,130,246,0.1);
}

.test-email-form button{
  display:flex;align-items:center;gap:6px;
  white-space:nowrap;cursor:pointer;
}

.test-email-form button:hover{
  opacity:0.9;
}

.test-email-form button:active{
  transform:scale(0.98);
}

.test-email-result{
  margin:12px 0 0;padding:10px 14px;border-radius:8px;
  font-size:13px;display:none;
}

.test-email-result.success{
  display:block;background:#dcfce7;border:1px solid #86efac;color:#166534;
}

.test-email-result.error{
  display:block;background:#fee2e2;border:1px solid #fca5a5;color:#991b1b;
}

.test-email-result.loading{
  display:block;background:#eff6ff;border:1px solid #bfdbfe;color:#1e40af;
}

/* Empty state */
.perimeter-empty{
  text-align:center;padding:40px 20px;color:var(--muted-text);
}

.perimeter-empty svg{
  width:48px;height:48px;margin-bottom:12px;opacity:0.5;
}

.perimeter-empty p{
  margin:0;font-size:14px;
}

/* Footer */
.site-footer{
  background:var(--footer-bg);padding:16px;text-align:center;
  margin:32px -16px 0;color:var(--muted-text);font-size:14px;
}
.site-footer p{margin:0}

/* Responsive */
@media (max-width:768px){
  body{
    padding:8px 8px 0;
  }

  .container{
    gap:12px;
    padding-top:100px; /* Space for 2-row topbar on mobile */
  }

  /* Use CSS Grid for precise 2-row mobile layout */
  #topbar{
    display:grid !important;
    grid-template-columns:auto 1fr !important;
    grid-template-rows:auto auto !important;
    gap:8px !important;
    padding:8px 10px !important;
    align-items:center !important;
  }

  /* Row 1, Column 1: subdomain toggle (left) */
  .topbar-left{
    grid-row:1 !important;
    grid-column:1 !important;
    justify-self:start !important;
  }

  /* Row 1, Column 2: status + hamburger (right) */
  .topbar-right{
    grid-row:1 !important;
    grid-column:2 !important;
    display:flex !important;
    justify-content:flex-end !important;
    align-items:center !important;
    gap:6px !important;
  }

  /* Row 2, full width: date controls (centered) */
  .topbar-center{
    grid-row:2 !important;
    grid-column:1 / -1 !important;
    display:flex !important;
    justify-content:center !important;
    align-items:center !important;
    flex-wrap:wrap !important;
    gap:6px !important;
  }

  /* Hide the text on mobile, show only icon */
  #site-nav-name{
    display:none;
  }

  .site-nav-toggle{
    padding:4px 6px;
  }

  .site-nav-arrow{
    width:10px;height:10px;
  }

  .site-nav-menu{
    min-width:220px;
  }

  /* Keep last online info on mobile (important info) */
  .last-online-info{
    padding:4px 6px;
    font-size:11px;
  }

  .last-online-info .clock-icon{
    width:16px;height:16px;
  }

  #lastOnlineText{
    font-size:11px;
  }

  /* Make battery indicator smaller on mobile */
  .battery-indicator{
    padding:6px 8px;
    min-width:auto;
  }

  .battery-icon-good,
  .battery-icon-low{
    width:20px;height:20px;
  }

  /* User name smaller on mobile */
  .user-name-display{
    font-size:11px;
    padding:4px 8px;
    max-width:80px;
  }

  /* Hamburger button smaller on mobile */
  .hamburger-btn{
    width:36px;height:36px;
    touch-action:manipulation;
  }

  .hamburger-btn span{
    width:18px;
  }

  /* Hamburger menu full width on mobile */
  .hamburger-menu{
    min-width:200px;
    right:-8px;
  }

  .menu-item{
    padding:10px 12px;
    font-size:13px;
  }

  /* Hamburger menu items need higher specificity to override #topbar button */
  #topbar .hamburger-menu .menu-item{
    padding:10px 12px;
    font-size:13px;
    touch-action:manipulation;
    -webkit-tap-highlight-color:transparent;
  }

  /* Date controls */
  #topbar button{
    padding:6px 8px;
    font-size:13px;
  }

  #calendarToggle{
    padding:6px 10px;
    min-width:120px;
    font-size:13px;
  }

  /* Map height adjustment */
  #map{
    height:50vh;
  }

  /* iBeacon form responsive */
  #ibeaconForm{
    grid-template-columns:1fr;
  }

  .form-actions{
    flex-direction:column;
  }

  .form-actions button{
    width:100%;justify-content:center;
  }

  /* Settings overlay responsive */
  .settings-content{
    width:95%;max-width:95%;
  }

  .setting-group{
    padding:16px;
  }

  .setting-header{
    flex-direction:column;align-items:flex-start;
  }

  .btn-default{
    align-self:flex-start;
  }

  .setting-input-group{
    flex-wrap:wrap;
  }

  .setting-input-group input[type="number"]{
    width:100%;
  }

  #settingsForm .form-actions{
    flex-direction:column;
  }

  #settingsForm .form-actions button{
    width:100%;justify-content:center;
  }

  /* Overlay content - mobile browser address bar fix */
  .overlay{
    /* Use dvh for dynamic viewport height on mobile */
    height:100dvh;
    height:100vh; /* fallback for older browsers */
    padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
  }

  .overlay-content{
    width:95%;
    max-height:85dvh;
    max-height:85vh; /* fallback */
    margin-bottom:env(safe-area-inset-bottom, 20px);
  }

  .overlay-header{
    padding:16px 20px;
    position:sticky;
    top:0;
    z-index:10;
  }

  .overlay-header h2{
    font-size:18px;
  }

  .overlay-body{
    padding:16px;
    padding-bottom:32px; /* Extra space for bottom button visibility */
  }

  /* Table horizontal scroll on mobile */
  #positionsTable{
    overflow-x:auto;
    padding:8px;
  }

  #positionsTable tbody{
    overflow-x:visible;
  }

  #positionsTable th,#positionsTable td{
    padding:6px 8px;
    font-size:13px;
  }

  /* Calendar */
  .calendar-dropdown{
    min-width:260px;
  }

  .calendar-grid{
    gap:2px;
  }

  .calendar-day{
    padding:6px 2px;
    font-size:12px;
  }

  /* Legend */
  .legend-content{
    font-size:12px;
    padding:8px 10px;
  }

  /* Footer */
  .site-footer{
    margin:24px -8px 0;
    font-size:13px;
  }
}

@media (max-width:480px){
  body{
    padding:4px 4px 0;
  }

  .container{
    padding-top:140px; /* Much more space for stacked topbar */
  }

  #topbar{
    padding:8px;
    flex-direction:column;
    align-items:stretch;
  }

  .topbar-center{
    flex-wrap:wrap;
    order:1;
    width:100%;
  }

  .topbar-right{
    order:2;
    width:100%;
    margin-top:8px;
    justify-content:space-between;
  }

  #calendarToggle{
    width:100%;
    order:-1;
  }

  #prevDay, #nextDay, #today{
    flex:1;
  }

  .calendar-dropdown{
    left:4px;right:4px;
    transform:none;
  }

  /* Hamburger menu positioned better on small screens */
  .hamburger-menu{
    right:-4px;
    min-width:180px;
  }

  /* Map smaller on very small screens */
  #map{
    height:40vh;
  }

  /* Overlay adjustments - smaller screens with address bar */
  .overlay-content{
    width:98%;
    max-height:80dvh;
    max-height:80vh; /* fallback */
    border-radius:8px;
    margin-bottom:env(safe-area-inset-bottom, 24px);
  }

  .overlay-header{
    padding:12px 16px;
    position:sticky;
    top:0;
    z-index:10;
  }

  .overlay-header h2{
    font-size:16px;
  }

  .overlay-body{
    padding:12px;
    padding-bottom:40px; /* More space for bottom buttons on small screens */
  }

  /* Ensure form buttons are visible */
  .form-actions{
    margin-bottom:16px;
  }

  /* Settings */
  .setting-group{
    padding:12px;
  }

  .setting-header label strong{
    font-size:14px;
  }

  .setting-description{
    font-size:12px;
  }

  /* Map selector */
  #selectorMap{
    height:300px;
  }

  /* Footer */
  .site-footer{
    margin:16px -4px 0;
    padding:12px;
    font-size:12px;
  }
}

/* ========== POSITION EDIT OVERLAY ========== */
.position-edit-content{
  max-width:700px;
}

.position-edit-info{
  background:var(--muted-bg);
  border-radius:8px;
  padding:16px;
  margin-bottom:16px;
}

.position-edit-info .info-row{
  display:flex;
  justify-content:space-between;
  padding:6px 0;
  border-bottom:1px solid var(--border);
}

.position-edit-info .info-row:last-child{
  border-bottom:none;
}

.position-edit-info .info-label{
  font-weight:500;
  color:var(--muted-text);
}

.position-edit-info .info-value{
  font-family:monospace;
  color:var(--text);
}

#positionEditMap{
  height:300px;
  border-radius:8px;
  border:1px solid var(--border);
  margin-top:8px;
}

.form-row-inline{
  display:flex;
  gap:16px;
}

.form-row-inline .form-field{
  flex:1;
}

.form-row-inline .form-field label{
  display:block;
  font-size:13px;
  color:var(--muted-text);
  font-weight:500;
  margin-bottom:6px;
}

.form-row-inline .form-field input{
  width:100%;
  padding:10px 12px;
  border:1px solid var(--border);
  border-radius:8px;
  font-size:14px;
  background:var(--card-bg);
  color:var(--text);
}

.form-row-inline .form-field input:focus{
  outline:none;
  border-color:var(--primary);
  box-shadow:0 0 0 3px rgba(14,165,233,0.1);
}

.form-row-inline .form-field input[readonly]{
  background:var(--muted-bg);
  cursor:not-allowed;
}

.position-edit-actions{
  margin-top:20px;
  flex-wrap:wrap;
}

/* Edit button in positions table */
.edit-position-btn{
  background:none;
  border:none;
  padding:4px;
  cursor:pointer;
  color:var(--muted-text);
  border-radius:4px;
  transition:all 0.2s;
  display:inline-flex;
  align-items:center;
  justify-content:center;
}

.edit-position-btn:hover{
  background:var(--muted-bg);
  color:var(--primary);
}

.edit-position-btn svg{
  width:16px;
  height:16px;
}

/* Adjust table for edit button column */
#positionsTable .pos-table th:last-child,
#positionsTable .pos-table td:last-child{
  width:40px;
  text-align:center;
}

/* ========== SETTINGS TABS NAVIGATION ========== */
.settings-tabs{
  display:flex;
  flex-wrap:wrap;
  gap:4px;
  margin-bottom:16px;
  border-bottom:2px solid var(--border);
  padding-bottom:0;
}

.settings-tab{
  padding:10px 16px;
  border:none;
  background:transparent;
  cursor:pointer;
  font-size:14px;
  font-weight:500;
  color:var(--muted-text);
  border-bottom:2px solid transparent;
  margin-bottom:-2px;
  transition:color 0.2s, border-color 0.2s, background 0.2s;
  border-radius:6px 6px 0 0;
  white-space:nowrap;
}

.settings-tab:hover{
  color:var(--text);
  background:var(--muted-bg);
}

.settings-tab.active{
  color:var(--primary);
  border-bottom-color:var(--primary);
  background:transparent;
  font-weight:600;
}

/* ========== SETTINGS SECTIONS (Tab Content) ========== */
.settings-section{
  display:none;
  border:1px solid var(--border);
  border-radius:8px;
  overflow:hidden;
  background:var(--surface);
}

.settings-section.open{
  display:block;
}

.settings-section-content{
  padding:16px;
}

/* Responsive tabs - stack on mobile */
@media (max-width:600px){
  .settings-tabs{
    gap:2px;
  }
  .settings-tab{
    padding:8px 10px;
    font-size:12px;
    flex:1;
    text-align:center;
    min-width:auto;
  }
}

/* Compact setting groups inside sections */
.settings-section .setting-group{
  padding:12px 0;
  border-bottom:1px solid var(--border);
}

.settings-section .setting-group:first-child{
  padding-top:0;
}

.settings-section .setting-group:last-child{
  padding-bottom:0;
  border-bottom:none;
}

.settings-section .setting-description{
  font-size:12px;
  margin-bottom:8px;
}

/* ========== MAC HISTORY TABLE ========== */
.mac-history-container{
  max-height:250px;
  overflow-y:auto;
  border:1px solid var(--border);
  border-radius:8px;
}

.mac-history-table{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}

.mac-history-table th,
.mac-history-table td{
  padding:8px 12px;
  text-align:left;
  border-bottom:1px solid var(--border);
}

.mac-history-table th{
  background:var(--muted-bg);
  font-weight:600;
  position:sticky;
  top:0;
  z-index:1;
}

.mac-history-table tbody tr{
  cursor:pointer;
  transition:background 0.15s;
}

.mac-history-table tbody tr:hover{
  background:var(--muted-bg);
}

.mac-history-table tbody tr.active{
  background:var(--primary);
  color:white;
}

.mac-history-table tbody tr:last-child td{
  border-bottom:none;
}

/* Position table row highlight */
#positionsTable .pos-table tbody tr.highlighted{
  background:var(--primary) !important;
  color:white;
}

#positionsTable .pos-table tbody tr.highlighted td{
  color:white;
}

/* ========== MULTI-DEVICE: Header Device Dropdown ========== */
.device-dropdown-container{
  position:relative;
}
.device-dropdown-container.hidden{
  display:none;
}
.device-dropdown-btn{
  display:flex;
  align-items:center;
  gap:5px;
  padding:4px 10px;
  border:1px solid var(--border);
  border-radius:8px;
  background:var(--card-bg);
  color:var(--text);
  cursor:pointer;
  font-size:13px;
  transition:background 0.15s;
  touch-action:manipulation;
  -webkit-tap-highlight-color:transparent;
}
.device-dropdown-btn:hover{
  background:var(--muted-bg);
}
.device-dropdown-btn .dropdown-arrow{
  transition:transform 0.2s;
}
.device-dropdown-menu{
  position:absolute;
  top:100%;
  right:0;
  margin-top:4px;
  min-width:200px;
  background:var(--card-bg);
  border:1px solid var(--border);
  border-radius:10px;
  box-shadow:0 8px 24px rgba(0,0,0,0.15);
  padding:6px 0;
  z-index:1100;
}
.device-dropdown-menu.hidden{
  display:none;
}
.device-dropdown-item{
  display:flex;
  align-items:center;
  gap:8px;
  padding:8px 14px;
  cursor:pointer;
  font-size:13px;
  color:var(--text);
  transition:background 0.1s;
  touch-action:manipulation;
}
.device-dropdown-item:hover{
  background:var(--muted-bg);
}
.device-dropdown-item input[type="checkbox"]{
  width:15px;
  height:15px;
  margin:0;
  accent-color:var(--primary);
}
.device-dd-dot{
  width:10px;
  height:10px;
  border-radius:50%;
  display:inline-block;
  flex-shrink:0;
}
.device-dd-name{
  flex:1;
}

/* ========== MULTI-DEVICE: Table Device Tabs ========== */
.device-tabs-container{
  padding:8px 12px 0;
}
.device-tabs-container.hidden{
  display:none;
}
.device-tabs{
  display:flex;
  gap:2px;
  border-bottom:2px solid var(--border);
}
.device-tab{
  display:flex;
  align-items:center;
  gap:6px;
  padding:8px 16px;
  border:none;
  background:transparent;
  color:var(--muted-text);
  font-size:13px;
  cursor:pointer;
  border-bottom:2px solid transparent;
  margin-bottom:-2px;
  transition:all 0.15s;
}
.device-tab:hover{
  color:var(--text);
  background:var(--muted-bg);
}
.device-tab.active{
  color:var(--primary);
  border-bottom-color:var(--primary);
  font-weight:600;
}
.device-tab-dot{
  width:8px;
  height:8px;
  border-radius:50%;
  display:inline-block;
}

/* ========== MULTI-DEVICE: Device Cards ========== */
.device-card{
  background:var(--card-bg);
  border:1px solid var(--border);
  border-radius:10px;
  padding:14px;
  margin-bottom:10px;
}
.device-card-header{
  display:flex;
  align-items:center;
  gap:8px;
  flex-wrap:wrap;
  margin-bottom:8px;
}
.device-color-indicator{
  width:14px;
  height:14px;
  border-radius:50%;
  flex-shrink:0;
  border:1px solid var(--border);
}
.device-card-name{
  font-weight:600;
  font-size:15px;
  color:var(--text);
}
.device-card-eui{
  font-size:12px;
  color:var(--muted-text);
  font-family:monospace;
}
.device-card-status{
  font-size:11px;
  padding:2px 8px;
  border-radius:10px;
  font-weight:600;
  margin-left:auto;
}
.device-card-status.active{
  background:#dcfce7;
  color:#166534;
}
.device-card-status.inactive{
  background:#fef2f2;
  color:#991b1b;
}
[data-theme="dark"] .device-card-status.active{
  background:#14532d;
  color:#86efac;
}
[data-theme="dark"] .device-card-status.inactive{
  background:#450a0a;
  color:#fca5a5;
}
.device-card-info{
  display:flex;
  gap:16px;
  font-size:13px;
  color:var(--muted-text);
  margin-bottom:10px;
}
.device-card-actions{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}

/* ========== MULTI-DEVICE: Small Buttons ========== */
.btn-sm{
  padding:5px 12px;
  font-size:12px;
  border:1px solid var(--border);
  border-radius:6px;
  cursor:pointer;
  background:var(--btn-bg);
  color:var(--text);
  transition:all 0.15s;
}
.btn-sm:hover{
  background:var(--muted-bg);
}
.btn-sm.btn-edit{
  border-color:var(--primary);
  color:var(--primary);
}
.btn-sm.btn-edit:hover{
  background:var(--primary);
  color:#fff;
}
.btn-sm.btn-toggle{
  border-color:#f59e0b;
  color:#f59e0b;
}
.btn-sm.btn-toggle:hover{
  background:#f59e0b;
  color:#fff;
}
.btn-sm.btn-danger{
  border-color:#ef4444;
  color:#ef4444;
}
.btn-sm.btn-danger:hover{
  background:#ef4444;
  color:#fff;
}

/* ========== MULTI-DEVICE: Comparison Panel ========== */
.comparison-panel{
  background:var(--card-bg);
  border:1px solid var(--border);
  border-radius:10px;
  padding:16px;
  margin:10px 0;
}
.comparison-panel.hidden{
  display:none;
}
.comparison-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:12px;
}
.comparison-header h3{
  margin:0;
  font-size:16px;
  color:var(--text);
}
.comparison-controls{
  display:flex;
  flex-direction:column;
  gap:12px;
}
.comparison-dates{
  display:flex;
  gap:12px;
  flex-wrap:wrap;
}
.comparison-dates label{
  display:flex;
  align-items:center;
  gap:6px;
  font-size:13px;
  color:var(--text);
}
.comparison-dates input[type="date"]{
  padding:5px 8px;
  border:1px solid var(--border);
  border-radius:6px;
  background:var(--card-bg);
  color:var(--text);
  font-size:13px;
}
.comparison-devices{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
}
.comparison-device-toggle{
  display:flex;
  align-items:center;
  gap:6px;
  font-size:13px;
  cursor:pointer;
  color:var(--text);
}
.comparison-device-toggle input[type="checkbox"]{
  width:14px;
  height:14px;
}

/* ========== MULTI-DEVICE: Perimeter Cards ========== */
.perimeter-card{
  background:var(--muted-bg);
  border:1px solid var(--border);
  border-radius:8px;
  padding:12px;
  margin-bottom:8px;
}
.perimeter-card-header{
  display:flex;
  align-items:center;
  gap:8px;
  flex-wrap:wrap;
  margin-bottom:6px;
}
.perimeter-radius{
  font-size:12px;
  color:var(--muted-text);
  background:var(--card-bg);
  padding:1px 8px;
  border-radius:10px;
  border:1px solid var(--border);
}
.perimeter-card-info{
  display:flex;
  gap:16px;
  font-size:12px;
  color:var(--muted-text);
  margin-bottom:8px;
}

/* ========== MULTI-DEVICE: Overlay Wide Variant ========== */
.overlay-wide{
  max-width:600px;
}

/* ========== MULTI-DEVICE: Empty State ========== */
.empty-state{
  text-align:center;
  color:var(--muted-text);
  padding:24px 16px;
  font-size:14px;
}

/* ========== MULTI-DEVICE: Close Button ========== */
.btn-close{
  background:none;
  border:none;
  font-size:24px;
  cursor:pointer;
  color:var(--muted-text);
  padding:0 4px;
  line-height:1;
}
.btn-close:hover{
  color:var(--text);
}

/* ========== MULTI-DEVICE: Checkbox Label ========== */
.checkbox-label{
  display:flex;
  align-items:center;
  gap:8px;
  cursor:pointer;
  font-size:14px;
  color:var(--text);
}
.checkbox-label input[type="checkbox"]{
  width:16px;
  height:16px;
}

/* ========== MULTI-DEVICE: Overlay Close Button ========== */
.overlay-close-btn{
  background:none;
  border:none;
  font-size:28px;
  cursor:pointer;
  color:var(--muted-text);
  padding:0;
  line-height:1;
}
.overlay-close-btn:hover{
  color:var(--text);
}

/* ========== MULTI-DEVICE: Responsive ========== */
@media(max-width:768px){
  .device-tabs{
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
  }
  .device-tab{
    white-space:nowrap;
    padding:6px 12px;
    font-size:12px;
  }
  .device-card-header{
    flex-direction:column;
    align-items:flex-start;
  }
  .device-card-status{
    margin-left:0;
  }
  .comparison-dates{
    flex-direction:column;
  }
  .overlay-wide{
    max-width:95vw;
  }
}

@media(max-width:480px){
  .device-view-btn{
    padding:4px 10px;
    font-size:12px;
  }
  .device-card{
    padding:10px;
  }
  .device-card-actions{
    flex-direction:column;
  }
  .device-card-actions .btn-sm{
    width:100%;
    text-align:center;
  }
}
